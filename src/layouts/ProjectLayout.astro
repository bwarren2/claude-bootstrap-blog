---
import BaseLayout from "./BaseLayout.astro";
import StatusBadge from "@components/StatusBadge.astro";
import DifficultyRating from "@components/DifficultyRating.astro";
import TechTag from "@components/TechTag.astro";
import TechniqueTag from "@components/TechniqueTag.astro";
import ProjectLinks from "@components/ProjectLinks.astro";
import TableOfContents from "@components/TableOfContents.astro";
import CostTracking from "@components/CostTracking.astro";
import LessonsLearned from "@components/LessonsLearned.astro";
import PromptSnippets from "@components/PromptSnippets.astro";
import type { CollectionEntry } from "astro:content";

interface Props {
  project: CollectionEntry<"projects">;
  headings: { depth: number; slug: string; text: string }[];
}

const { project, headings } = Astro.props;
const {
  title,
  description,
  pubDate,
  updatedDate,
  status,
  difficulty,
  ambitionRating,
  repoUrl,
  liveUrl,
  transcriptUrls,
  techStack,
  claudeTechniques,
  costTracking,
  lessonsLearned,
  promptSnippets,
} = project.data;

const formattedDate = pubDate.toLocaleDateString("en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
});

const formattedUpdated = updatedDate?.toLocaleDateString("en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
});

const ogImage = new URL(`${import.meta.env.BASE_URL.replace(/\/?$/, "/")}og/${project.id}.png`, Astro.site).toString();
---

<BaseLayout title={title} description={description} image={ogImage} type="article" pubDate={pubDate}>
  <article class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Article header -->
    <header class="mb-8 pb-8 border-b border-border">
      <div class="flex flex-wrap items-center gap-3 mb-4">
        <StatusBadge status={status} />
        <DifficultyRating difficulty={difficulty} />
        <span class="text-sm text-text-secondary" title="Ambition rating">
          {"★".repeat(ambitionRating)}{"☆".repeat(5 - ambitionRating)}
        </span>
      </div>

      <h1 class="text-3xl sm:text-4xl font-bold text-text-primary mb-4">{title}</h1>
      <p class="text-lg text-text-secondary mb-4">{description}</p>

      <div class="flex flex-wrap items-center gap-4 text-sm text-text-secondary mb-4">
        <time datetime={pubDate.toISOString()}>Published {formattedDate}</time>
        {formattedUpdated && <span>Updated {formattedUpdated}</span>}
      </div>

      <div class="flex flex-wrap gap-1.5 mb-4">
        {techStack.map((tech) => <TechTag tech={tech} size="md" />)}
      </div>

      {
        claudeTechniques.length > 0 && (
          <div class="flex flex-wrap gap-1.5 mb-4">
            {claudeTechniques.map((t) => (
              <TechniqueTag technique={t} size="md" />
            ))}
          </div>
        )
      }

      <ProjectLinks repoUrl={repoUrl} liveUrl={liveUrl} transcriptUrls={transcriptUrls} />
    </header>

    <!-- Two-column layout -->
    <div class="lg:grid lg:grid-cols-[1fr_280px] lg:gap-8">
      <!-- Main content -->
      <div class="prose prose-lg max-w-none prose-headings:text-text-primary prose-a:text-brand prose-a:no-underline hover:prose-a:underline prose-code:text-brand prose-code:bg-brand/10 prose-code:px-1 prose-code:py-0.5 prose-code:rounded prose-code:before:content-none prose-code:after:content-none">
        <slot />
      </div>

      <!-- Sidebar -->
      <aside class="hidden lg:block">
        <div class="sticky top-24 space-y-6">
          <TableOfContents headings={headings} />
          <CostTracking costTracking={costTracking} />
        </div>
      </aside>
    </div>

    <LessonsLearned lessonsLearned={lessonsLearned} />
    <PromptSnippets snippets={promptSnippets} />
  </article>
</BaseLayout>
